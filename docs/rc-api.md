# Remote Control API

## Назначение

Описываемый интерфейс прикладного программирования (API&nbsp;– Application Programming Interface) предназначен для реализации тех или иных частей приложения, требующих удалённый доступ к функциям устройства.

## Функции

API содержит набор функций, которые можно вызывать как из кода приложения, так и из **IPython** консоли. Функции определены в классе `SdcCore`, поэтому доступ к ним осуществляется через объект класса `sdc`.

Для доступа к MMR используются т.н. идентификаторы регистров. Идентификатор регистра представляет собой член объекта класса, определяющий регистр доступа. Объект класса определяет модуль, в котором определён регистр. Например:

```python
class CamMod:
    def __init__(self):
        self._mod  = 1
        self._cr   = 0
        self._cr_s = 1
        self._cr_c = 2
        self._sr   = 3
    
    def cr(self):   return (self._mod << MOD_IDX_OFFSET) + self._cr
    def cr_s(self): return (self._mod << MOD_IDX_OFFSET) + self._cr_s
    def cr_c(self): return (self._mod << MOD_IDX_OFFSET) + self._cr_c
    def sr(self):   return (self._mod << MOD_IDX_OFFSET) + self._sr

...
cam    = CamMod()    
```

Тут имя регистра связано с именем функции класса, которая возвращает числовое значение идентификатора регистра, используемое при формировании сообщений протокола удалённого управления.

Такое описание позволяет избежать ряда ошибок при вызове функций доступ к MMR, связанных с несоответствием имени регистра модулю.

### Содержание

1. Чтение MMR
1. Запись MMR
1. Выполнение функции

### Чтение MMR

Для чтения MMR предназначены две функции:

1. `def rmmr(self, rid): ...`
1. `def _rmmr(self, *args): ...`

Первая функция более удобна для вызова вручную в консоли и является "обёрткой" над второй&nbsp;– использует внутри себя. Функция печатает на экран результат выполнения.

Вторая функция предназначена для внутреннего использования&nbsp;– вызова внутри кода приложения.

Аргументом `rmmr()` является идентификатор регистра `rid` (см. выше).

Аргументом `_rmmr()` является список параметров, передаваемых через запятую&nbsp;– это обычный синтаксис языка **Python**.

#### Пример:

```python
In [1]: sdc.rmmr(drc.cam.cr)
Out[1]: 3
```

### Запись MMR

Для записи в MMR предусмотрены две функции:

1. `def wmmr(self, rid, data): ...`
1. `def _wmmr(self, *args): ...`

Как и в случае с чтением MMR, первая функция более удобна для вызова вручную в консоли и так же является "обёрткой" над второй&nbsp;– использует внутри себя. Функция печатает на экран результат выполнения.

Вторая фукнция предназначена для внутреннего использования&nbsp;– вызова внутри кода приложения.

Аргументом `wmmr()` является идентификатор регистра `rid` (см. выше) и слово данных `data`.

Аргументом `_wmmr()`, как в случае с `_rmmr`, является список параметров, передаваемых через запятую&nbsp;– это обычный синтаксис языка **Python**.

#### Пример:

```python
In [8]: sdc.wmmr(drc.cam.cr_s, 3)
successful MMR write
```

### Выполнение функции

Для выполнения функций на устройстве используется функция API:

`def _dev_fun_exec(self, *args): ...`

Функция получает список аргументов, передаваемых через запятую, где первым аргументом идёт идентификатор операции (вызываемой внутри устройства функции), который является целым числом, далее через запятую передаются опциональные параметры, например:

```python
In [10]: sdc._dev_fun_exec(0, 1, 2)
Out[10]: array([0], dtype=uint16)
```

В этом примере выполняется функция устройства с идентификатором `0`, устройство никаких данных не возвращает, присылает только сообщение-квитанцию. Вызов другой функции:

```python
In [11]: sdc._dev_fun_exec(1, 1, 2)
Out[11]: array([767,   1,   2], dtype=uint16)

```

Здесь выполняется функция устройства с идентификатором `1`, устройство возвращает три слова: заголовок, в котором закодировано количество возвращаемых данных, и сами данные.

Попытка выполнить неподдерживаемую функцию, завершается получением сообщения-квитанции с кодом ошибки:

```python
In [15]: drc.vhex(sdc._dev_fun_exec(2, 1, 2))
E: request returns error code: "unsupported operation code"
['0x40f']
```

В этом примере передан идентификатор функции устройства `2`, который не соответствует списку поддерживаемых.